name: EAS Development Build

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      NPM_CONFIG_LEGACY_PEER_DEPS: "true"
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Install dependencies
        working-directory: ./frontend
        run: |
          echo "legacy-peer-deps=true" >> .npmrc
          npm install --legacy-peer-deps

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Generate Gradle Wrapper JAR
        working-directory: ./frontend/android
        run: |
          gradle wrapper --gradle-version=$(grep distributionUrl gradle/wrapper/gradle-wrapper.properties | sed 's/.*gradle-\(.*\)-bin.zip/\1/')

      - name: Generate Android Keystore
        working-directory: ./frontend
        run: |
          keytool -genkeypair -v \
            -keystore android.keystore \
            -alias my-key-alias \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000 \
            -storepass android \
            -keypass android \
            -dname "CN=Securestop, OU=Dev, O=Securestop, L=NJ, S=NJ, C=US"
          echo '{
            "android": {
              "keystore": {
                "keystorePath": "android.keystore",
                "keystorePassword": "android",
                "keyAlias": "my-key-alias",
                "keyPassword": "android"
              }
            }
          }' > credentials.json

      - name: Build Android dev client (APK)
        working-directory: ./frontend
        env:
          EXPO_NO_DOCTOR: "1"
        run: eas build --profile development --platform android --local --output ./build.apk

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: dev-build-apk
          path: ./frontend/build.apk
          if-no-files-found: error
